name: "Release Activepieces piece: decidim"

on:
  push:
    branches:
      - "release/decidim"
    paths:
      - "packages/pieces/community/decidim/**"

permissions:
  contents: write

concurrency:
  group: release-decidim
  cancel-in-progress: true

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install deps
        run: bun install

      - name: Run decidim tests
        run: npx nx test pieces-decidim

      - name: Read decidim version (jq)
        id: ver
        run: |
          VERSION=$(cat packages/pieces/community/decidim/package.json | jq -r '.version')
          if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
            echo "Could not read version from package.json"
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "DecidimPiece version: $VERSION"

      - name: Build piece tarball (non-interactive)
        run: npm run build-piece -- decidim

      - name: Locate built tgz
        id: tgz
        run: |
          TGZ_PATH=$(ls -1 dist/**/activepieces-piece-decidim-*.tgz | head -n 1)
          if [ -z "$TGZ_PATH" ]; then
            echo "Could not find built tgz in dist/"
            exit 1
          fi
          echo "tgz_path=$TGZ_PATH" >> "$GITHUB_OUTPUT"
          echo "Built tgz: $TGZ_PATH"

      - name: Create renamed tarballs
        run: |
          mkdir -p out
          cp "${{ steps.tgz.outputs.tgz_path }}" "out/decidim-${{ steps.ver.outputs.version }}.tgz"
          cp "${{ steps.tgz.outputs.tgz_path }}" "out/decidim-latest.tgz"
          ls -la out

      - name: Create / update GitHub Release (tag = decidim-<version>)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.ver.outputs.version }}
        run: |
          TAG="decidim-${VERSION}"
          TITLE="decidim ${VERSION}"

          if ! gh release view "$TAG" >/dev/null 2>&1; then
            gh release create "$TAG" --title "$TITLE" --notes "Activepieces piece decidim ${VERSION}"
          fi

          gh release upload "$TAG" \
            "out/decidim-${VERSION}.tgz#decidim-${VERSION}.tgz" \
            "out/decidim-latest.tgz#decidim-latest.tgz" \
            --clobber
